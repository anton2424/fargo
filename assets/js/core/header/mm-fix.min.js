jQuery( document ).ready( function( $ ) {
	/**Is Mobile*/
    var isMobile = {
		iOS: function() {
            return navigator.userAgent.match(/iPhone|iPad|iPod/i);
        },
        Android: function() {
            return navigator.userAgent.match(/Android/i);
        },
		Windows: function() {
            return navigator.userAgent.match(/IEMobile/i);
        },
		BlackBerry: function() {
            return navigator.userAgent.match(/BlackBerry/i);
        },
		Opera: function() {
            return navigator.userAgent.match(/Opera Mini/i);
        },
        any: function() {
            return (isMobile.iOS() || isMobile.Android() || isMobile.Windows() || isMobile.BlackBerry() || isMobile.Opera());
        }
    };
	    /**Sticky*/
        var main_menu = $( '.main-menu').length ?  true : false;
        $('.main-menu').eq(0).wrap( '<div class="main-menu-wrapper">' );
        $wrap =  $( '.main-menu-wrapper');
        $wrap.addClass( 'no-scroll' );
		
        var header_fixed = $('.main-menu').eq(0);

        var header_h = header_fixed.height() || 0;

        var topbar = $( '#wpadminbar' ).height() || 0;
        if (  topbar > 0 ) {
            var  topbar_pos = $( '#wpadminbar').css( 'position' );
            if ( 'fixed' !== topbar_pos ) {
                topbar = 0;
            }
        }
		
		/**Admin Bar Height*/
        function setUpHeaderHeight(){
            topbar = $( '#wpadminbar' ).height() || 0;
            if (  topbar > 0 ) {
                var  topbar_pos = $( '#wpadminbar').css( 'position' );
                if ( 'fixed' !== topbar_pos ) {
                    topbar = 0;
                }
            }
            header_fixed.height( 'auto' );
            $wrap.height( 'auto' );

            jQuery('.main-menu').css( 'line-height', 'auto' );

            header_h = header_fixed.height() || 0;
			
            var header_height = jQuery('.main-menu').height();
            jQuery('.main-menu').css( 'line-height', 'auto' );

            $( window ).trigger('site_header_height_changed');
        }

        $( window).resize( function(){
            setUpHeaderHeight();
        } );

		/**Fix Sofari*/
        for ( var i = i; i <= 10; i++ ) {
            setTimeout( function(){
                setUpHeaderHeight();
            } , i*1000 );
        }

		/**Move Sticky*/
        $( document ).scroll( function(){
            var header_parent = header_fixed.parent();
            var p_to_top = header_parent.offset().top;
            var st = $( document ).scrollTop();
            if( st > p_to_top && st > 0 ) {
                $wrap.addClass( 'is-fixed').removeClass( 'no-scroll' );
                header_fixed.addClass('header-fixed');
                header_fixed.css( 'top', topbar+'px' );
            } else {
                header_fixed.removeClass('header-fixed');
                header_fixed.css( 'top', 'auto' );
                $wrap.removeClass( 'is-fixed' ).addClass( 'no-scroll' );
            }
        });



    /**Mobile*/
    var mobile_max_width =  1140; // Media max width for mobile
    var main_navigation = jQuery('.main-navigation');
    var stite_header =  $( '.main-menu' );

    // Initialise Menu Toggle
    jQuery('#nav-toggle').on('click', function(event){
        event.preventDefault();
        jQuery('#nav-toggle').toggleClass('nav-is-visible');
        main_navigation.toggleClass("main-menu-mobile");
        jQuery('.header-widget').toggleClass("header-widget-mobile");
        if ( main_navigation.hasClass( 'main-menu-mobile' ) && $( window).width() <= mobile_max_width ) {
            var h = $( window).height( ) - stite_header.height();
            main_navigation.css( {
                height: h,
                overflow: 'auto',
            });
        } else {
            main_navigation.removeAttr( 'style' );
        }
    });

    $( window).resize( function(){
        if ( main_navigation.hasClass( 'main-menu-mobile' ) && $( window).width() <= mobile_max_width ) {
            var h = $( window).height( ) - stite_header.height();
            main_navigation.css( {
                height: h,
                overflow: 'auto',
            });
        } else {
            main_navigation.removeAttr( 'style' );
        }
    } );

    jQuery('.onepress-menu li.menu-item-has-children, .onepress-menu li.page_item_has_children').each( function() {
        jQuery(this).prepend('<div class="nav-toggle-subarrow"><i class="fa fa-angle-down"></i></div>');
    });

    jQuery('.nav-toggle-subarrow, .nav-toggle-subarrow .nav-toggle-subarrow').click(
        function () {
            jQuery(this).parent().toggleClass("nav-toggle-dropdown");
        }
    );

    // Get the header height and wpadminbar height if enable.
    var h;
    window.current_nav_item = false;
    if ( onepress_js_settings.onepress_disable_sticky_header != '1' ) {
        h = jQuery('#wpadminbar').height() + jQuery('.main-menu').height();
    } else {
        h = jQuery('#wpadminbar').height();
    }

    // Navigation click to section.
    jQuery('.main-navigation li a[href*="#"]').on('click', function(event){
        event.preventDefault();
        // if in mobile mod
        if (  jQuery( '.main-navigation' ).hasClass( 'main-menu-mobile' ) ) {
            jQuery( '#nav-toggle' ).trigger( 'click' );
        }
        smoothScroll( jQuery( this.hash ) );
    });

    function setNavActive( currentNode ){
        if ( currentNode ) {
            currentNode = currentNode.replace('#', '');
            if (currentNode)
                jQuery('.main-navigation li').removeClass('onepress-current-item');
            if (currentNode) {
                jQuery('.main-navigation li').find('a[href$="#' + currentNode + '"]').parent().addClass('onepress-current-item');
            }
        }
    }

    function inViewPort( $element, offset_top ){
        if ( ! offset_top ) {
            offset_top = 0
        }
        var view_port_top = jQuery( window ).scrollTop();
        if ( $('#wpadminbar' ).length > 0 ) {
            view_port_top -= $('#wpadminbar' ).outerHeight() - 1;
            offset_top += $('#wpadminbar' ).outerHeight() - 1;
        }
        var view_port_h = $( 'body' ).outerHeight();

        var el_top = $element.offset().top;
        var eh_h = $element.height();
        var el_bot = el_top + eh_h;
        var view_port_bot = view_port_top + view_port_h;

        var all_height = $( 'body' )[0].scrollHeight;
        var max_top = all_height - view_port_h;


        var in_view_port = false;
        // If scroll maximum
        if ( view_port_top >= max_top ) {

            if ( ( el_top < view_port_top &&  el_top > view_port_bot ) || ( el_top > view_port_top && el_bot < view_port_top  ) ) {
                in_view_port = true;
            }

        } else {
            if ( el_top <= view_port_top + offset_top ) {
                //if ( eh_bot > view_port_top &&  eh_bot < view_port_bot ) {
                if ( el_bot > view_port_top  ) {
                    in_view_port = true;
                }
            }
        }
        return in_view_port;
    }

    // Add active class to menu when scroll to active section.
    var _scroll_top = jQuery(window).scrollTop();
    jQuery( window ).scroll(function() {
        var currentNode = null;

        if ( ! window.current_nav_item ) {
            var current_top = jQuery( window ).scrollTop();

            if ( onepress_js_settings.onepress_disable_sticky_header != '1' ) {
                h = jQuery('#wpadminbar').height() + jQuery('.main-menu').height();
            } else {
                h = jQuery('#wpadminbar').height();
            }

            if( _scroll_top < current_top )
            {
                jQuery('section').each( function ( index ) {
                    var section = jQuery( this );
                    var currentId = section.attr('id') || '';

                    var in_vp = inViewPort( section , h + 10) ;
                    if ( in_vp ) {
                        currentNode = currentId;
                    }
                });

            } else {
                var ns = jQuery('section').length;
                for ( var i = ns - 1; i >= 0; i-- ) {
                    var section = jQuery('section').eq( i );
                    var currentId = section.attr('id') || '';
                    var in_vp = inViewPort( section , h + 10) ;
                    if ( in_vp ) {
                        currentNode = currentId;
                    }

                }
            }
            _scroll_top = current_top;

        } else {
            currentNode = window.current_nav_item.replace('#', '');
        }

        setNavActive( currentNode );
    });

    // Move to the right section on page load.
    jQuery(window).load(function(){
        var urlCurrent = location.hash;
        if ( jQuery( urlCurrent ).length > 0 ) {
            smoothScroll( urlCurrent );
        }
    });
});